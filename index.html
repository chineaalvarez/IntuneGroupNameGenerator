<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Intune Group Name Generator</title>
  <style>
    .field-block { margin-bottom: 10px; }
    label { font-weight: bold; display: block; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>Intune Group Name Generator</h1>
  <div id="formContainer"></div>
  <button onclick="generateGroupName()">Generate</button>
  <p><strong>Result:</strong> <span id="output"></span></p>

  <script>
    let schema;

    fetch('schema.json')
      .then(res => res.json())
      .then(data => {
        schema = data;
        createFormFromSchema(schema);
      })
      .catch(err => {
        document.getElementById("formContainer").innerHTML = "<p>Error loading schema</p>";
        console.error("Error loading schema:", err);
      });

    function createFormFromSchema(schema) {
      const container = document.getElementById("formContainer");
      container.innerHTML = '';

      schema.Fields.forEach(field => {
        const key = Object.keys(field)[0];
        const config = field[key];
        const block = document.createElement("div");
        block.className = "field-block";
        block.dataset.fieldName = key;

        const label = document.createElement("label");
        label.textContent = key;
        block.appendChild(label);

        if (config.FieldType === "Static") {
          const input = document.createElement("input");
          input.type = "text";
          input.value = config.Value;
          input.disabled = true;
          input.dataset.key = key;
          block.appendChild(input);
        } else if (config.FieldType === "FreeText") {
          const input = document.createElement("input");
          input.type = "text";
          input.placeholder = key;
          input.dataset.key = key;
          block.appendChild(input);
        } else if (config.FieldType === "Predefined") {
          const select = document.createElement("select");
          select.dataset.key = key;

          const defaultOpt = document.createElement("option");
          defaultOpt.value = '';
          defaultOpt.textContent = `Select ${key}`;
          select.appendChild(defaultOpt);

          config.Values.forEach(v => {
            const option = document.createElement("option");
            option.value = v.Value;
            option.textContent = v.FriendlyName;
            select.appendChild(option);
          });

          select.addEventListener("change", () => {
            const selected = config.Values.find(v => v.Value === select.value);
            handleDynamicSubfields(selected, config, select);
          });

          block.appendChild(select);
        }

        container.appendChild(block);
      });
    }

    function handleDynamicSubfields(selected, config, parentElement) {
      const container = document.getElementById("formContainer");

      document.querySelectorAll(".subfield").forEach(e => e.remove());
      document.querySelectorAll(".hidden").forEach(e => e.classList.remove("hidden"));

      if (!selected) return;

      if (selected.HideFields) {
        selected.HideFields.forEach(fieldName => {
          const el = document.querySelector(`[data-field-name="${fieldName}"]`);
          if (el) el.classList.add("hidden");
        });
      }

      if (selected.SubFields) {
        selected.SubFields.forEach(sub => {
          const subKey = Object.keys(sub)[0];
          const subConfig = sub[subKey];
          const subBlock = document.createElement("div");
          subBlock.className = "field-block subfield";

          const label = document.createElement("label");
          label.textContent = subKey;
          subBlock.appendChild(label);

          let input;
          if (subConfig.FieldType === "FreeText") {
            input = document.createElement("input");
            input.type = "text";
          } else if (subConfig.FieldType === "Predefined") {
            input = document.createElement("select");
            subConfig.Values.forEach(opt => {
              const option = document.createElement("option");
              option.value = opt.Value;
              option.textContent = opt.FriendlyName;
              input.appendChild(option);
            });
          }

          input.dataset.key = subKey;
          subBlock.appendChild(input);
          container.appendChild(subBlock);
        });
      }
    }

    function generateGroupName() {
      let groupName = "";
      const container = document.getElementById("formContainer");

      schema.Fields.forEach(field => {
        const key = Object.keys(field)[0];
        const config = field[key];
        const block = document.querySelector(`[data-field-name="${key}"]`);
        if (block?.classList.contains("hidden")) return;

        const input = container.querySelector(`[data-key="${key}"]`);
        if (input && input.value) {
          groupName += input.value + config.Delimiter;
        }

        const selected = config.Values?.find(v => v.Value === input?.value);
        if (selected?.SubFields) {
          selected.SubFields.forEach(sub => {
            const subKey = Object.keys(sub)[0];
            const subConfig = sub[subKey];
            const subInput = container.querySelector(`[data-key="${subKey}"]`);
            if (subInput?.value) {
              groupName += subConfig.Delimiter + subInput.value;
            }
          });
        }
      });

      document.getElementById("output").textContent = groupName.replace(/[-_]+$/, "");
    }
  </script>
</body>
</html>